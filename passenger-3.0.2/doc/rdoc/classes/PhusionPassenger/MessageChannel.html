<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Class: PhusionPassenger::MessageChannel</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=480,width=750" ).focus();
        }
      // ]]>
    </script>
  </head>

  <body>
  <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'><tr>
  <td class="file-title"><span class="file-title-prefix">Class</span><br />PhusionPassenger::MessageChannel</td>
  <td align="right">
    <table cellspacing="0" cellpadding="2">
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../files/lib/phusion_passenger/message_channel_rb.html">lib/phusion_passenger/message_channel.rb</a>
        </td>
      </tr>
    <tr>
      <td>Parent:</td>
      <td>
Object
     </td>
   </tr>
         </table>
        </td>
        </tr>
      </table>
 <!-- banner header -->

  <div id="bodyContent">
      <div id="content">

  <div class="description"><p>
This class provides convenience methods for:
</p>
<ul>
<li>sending and receiving raw data over an <a href="../IO.html">IO</a> channel.

</li>
<li>sending and receiving messages over an <a href="../IO.html">IO</a> channel.

</li>
<li>file descriptor (<a href="../IO.html">IO</a> object) passing over a Unix
socket.

</li>
</ul>
<p>
All of these methods use exceptions for error reporting.
</p>
<p>
There are two kinds of messages:
</p>
<dl>
<dt> Array messages </dt><dd>These are just a list of strings, and the message itself has a specific
length. The contained strings may not contain NUL characters
(<tt>&#8217;\0&#8216;</tt>). Note that an array message must have at least
one element.

</dd>
<dt> Scalar messages </dt><dd>These are byte strings which may contain arbitrary binary data. Scalar
messages also have a specific length.

</dd>
</dl>
<p>
The protocol is designed to be low overhead, easy to implement and easy to
parse.
</p>
<p>
<a href="MessageChannel.html">MessageChannel</a> is to be wrapped around an
<a href="../IO.html">IO</a> object. For example:
</p>
<pre>
 a, b = IO.pipe
 channel1 = MessageChannel.new(a)
 channel2 = MessageChannel.new(b)

 # Send an array message.
 channel2.write(&quot;hello&quot;, &quot;world !!&quot;)
 channel1.read    # =&gt; [&quot;hello&quot;, &quot;world !!&quot;]

 # Send a scalar message.
 channel2.write_scalar(&quot;some long string which can contain arbitrary binary data&quot;)
 channel1.read_scalar
</pre>
<p>
The life time of a <a href="MessageChannel.html">MessageChannel</a> is
independent from that of the wrapped <a href="../IO.html">IO</a> object. If
a <a href="MessageChannel.html">MessageChannel</a> object is destroyed, the
underlying <a href="../IO.html">IO</a> object is not automatically closed.
Call <a href="MessageChannel.html#M000355">close</a>() if you want to <a
href="MessageChannel.html#M000355">close</a> the underlying <a
href="../IO.html">IO</a> object.
</p>
<p>
Note: Be careful with mixing the sending/receiving of array messages,
scalar messages and <a href="../IO.html">IO</a> objects. If you send a
collection of any of these in a specific order, then the receiving side
must receive them in the exact some order. So suppose you first send a
message, then an <a href="../IO.html">IO</a> object, then a scalar, then
the receiving side must first receive a message, then an <a
href="../IO.html">IO</a> object, then a scalar. If the receiving side does
things in the wrong order then bad things will happen.
</p>
</div>



  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="#M000355">close</a></li>
  <li><a href="#M000356">closed?</a></li>
  <li><a href="#M000354">fileno</a></li>
  <li><a href="#M000346">new</a></li>
  <li><a href="#M000347">read</a></li>
  <li><a href="#M000348">read_hash</a></li>
  <li><a href="#M000349">read_scalar</a></li>
  <li><a href="#M000352">recv_io</a></li>
  <li><a href="#M000353">send_io</a></li>
  <li><a href="#M000350">write</a></li>
  <li><a href="#M000351">write_scalar</a></li>
  </ul>



  <div class="sectiontitle">Classes and Modules</div>
  Class <a href="MessageChannel/InvalidHashError.html" class="link">PhusionPassenger::MessageChannel::InvalidHashError</a><br />



  <div class="sectiontitle">Attributes</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class='attr-rw'>
[RW]
    </td>
    <td class='attr-name'>io</td>
    <td class='attr-desc'>
The wrapped <a href="../IO.html">IO</a> object.

</td>
  </tr>
  </table>

<div class="sectiontitle">Public Class methods</div>
<div class="method">
  <div class="title">
    <a name="M000346"></a><b>new</b>(io = nil)
  </div>
  <div class="description">
  <p>
Create a <a href="MessageChannel.html#M000346">new</a> <a
href="MessageChannel.html">MessageChannel</a> by wrapping the given <a
href="../IO.html">IO</a> object.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000346_source')" id="l_M000346_source">show source</a> ]</p>
  <div id="M000346_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File lib/phusion_passenger/message_channel.rb, line 88</span>
88:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">io</span> = <span class="ruby-keyword kw">nil</span>)
89:                 <span class="ruby-ivar">@io</span> = <span class="ruby-identifier">io</span>
90:                 <span class="ruby-comment cmt"># Make it binary just in case.</span>
91:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">binmode</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@io</span>
92:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="sectiontitle">Public Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000355"></a><b>close</b>()
  </div>
  <div class="description">
  <p>
Close the underlying <a href="../IO.html">IO</a> stream. Might raise
SystemCallError or IOError when something goes wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000355_source')" id="l_M000355_source">show source</a> ]</p>
  <div id="M000355_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/message_channel.rb, line 360</span>
360:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">close</span>
361:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">close</span>
362:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000356"></a><b>closed?</b>()
  </div>
  <div class="description">
  <p>
Checks whether the underlying <a href="../IO.html">IO</a> stream is closed.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000356_source')" id="l_M000356_source">show source</a> ]</p>
  <div id="M000356_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/message_channel.rb, line 365</span>
365:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">closed?</span>
366:                 <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">closed?</span>
367:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000354"></a><b>fileno</b>()
  </div>
  <div class="description">
  <p>
Return the file descriptor of the underlying <a href="../IO.html">IO</a>
object.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000354_source')" id="l_M000354_source">show source</a> ]</p>
  <div id="M000354_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/message_channel.rb, line 354</span>
354:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fileno</span>
355:                 <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">fileno</span>
356:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000347"></a><b>read</b>()
  </div>
  <div class="description">
  <p>
Read an array message from the underlying file descriptor. Returns the
array message as an array, or nil when end-of-stream has been reached.
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000347_source')" id="l_M000347_source">show source</a> ]</p>
  <div id="M000347_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/message_channel.rb, line 100</span>
100:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read</span>
101:                 <span class="ruby-identifier">buffer</span> = <span class="ruby-identifier">new_buffer</span>
102:                 <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-constant">HEADER_SIZE</span>, <span class="ruby-identifier">buffer</span>)
103:                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
104:                 <span class="ruby-keyword kw">end</span>
105:                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">HEADER_SIZE</span>
106:                         <span class="ruby-identifier">tmp</span> = <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-constant">HEADER_SIZE</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>)
107:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tmp</span>.<span class="ruby-identifier">empty?</span>
108:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
109:                         <span class="ruby-keyword kw">else</span>
110:                                 <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tmp</span>
111:                         <span class="ruby-keyword kw">end</span>
112:                 <span class="ruby-keyword kw">end</span>
113:                 
114:                 <span class="ruby-identifier">chunk_size</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">unpack</span>(<span class="ruby-constant">UINT16_PACK_FORMAT</span>)[<span class="ruby-value">0</span>]
115:                 <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">chunk_size</span>, <span class="ruby-identifier">buffer</span>)
116:                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
117:                 <span class="ruby-keyword kw">end</span>
118:                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">chunk_size</span>
119:                         <span class="ruby-identifier">tmp</span> = <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">chunk_size</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>)
120:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tmp</span>.<span class="ruby-identifier">empty?</span>
121:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
122:                         <span class="ruby-keyword kw">else</span>
123:                                 <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tmp</span>
124:                         <span class="ruby-keyword kw">end</span>
125:                 <span class="ruby-keyword kw">end</span>
126:                 
127:                 <span class="ruby-identifier">message</span> = []
128:                 <span class="ruby-identifier">offset</span> = <span class="ruby-value">0</span>
129:                 <span class="ruby-identifier">delimiter_pos</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">index</span>(<span class="ruby-constant">DELIMITER</span>, <span class="ruby-identifier">offset</span>)
130:                 <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-identifier">delimiter_pos</span>.<span class="ruby-identifier">nil?</span>
131:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
132:                                 <span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&quot;</span>
133:                         <span class="ruby-keyword kw">else</span>
134:                                 <span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">buffer</span>[<span class="ruby-identifier">offset</span> <span class="ruby-operator">..</span> <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>]
135:                         <span class="ruby-keyword kw">end</span>
136:                         <span class="ruby-identifier">offset</span> = <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
137:                         <span class="ruby-identifier">delimiter_pos</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">index</span>(<span class="ruby-constant">DELIMITER</span>, <span class="ruby-identifier">offset</span>)
138:                 <span class="ruby-keyword kw">end</span>
139:                 <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">message</span>
140:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNRESET</span>
141:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
142:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000348"></a><b>read_hash</b>()
  </div>
  <div class="description">
  <p>
Read an array message from the underlying file descriptor and return the
result as a hash instead of an array. This assumes that the array message
has an even number of elements. Returns nil when end-of-stream has been
reached.
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000348_source')" id="l_M000348_source">show source</a> ]</p>
  <div id="M000348_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/message_channel.rb, line 151</span>
151:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_hash</span>
152:                 <span class="ruby-identifier">buffer</span> = <span class="ruby-identifier">new_buffer</span>
153:                 <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-constant">HEADER_SIZE</span>, <span class="ruby-identifier">buffer</span>)
154:                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
155:                 <span class="ruby-keyword kw">end</span>
156:                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">HEADER_SIZE</span>
157:                         <span class="ruby-identifier">tmp</span> = <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-constant">HEADER_SIZE</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>)
158:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tmp</span>.<span class="ruby-identifier">empty?</span>
159:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
160:                         <span class="ruby-keyword kw">else</span>
161:                                 <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tmp</span>
162:                         <span class="ruby-keyword kw">end</span>
163:                 <span class="ruby-keyword kw">end</span>
164:                 
165:                 <span class="ruby-identifier">chunk_size</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">unpack</span>(<span class="ruby-constant">UINT16_PACK_FORMAT</span>)[<span class="ruby-value">0</span>]
166:                 <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">chunk_size</span>, <span class="ruby-identifier">buffer</span>)
167:                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
168:                 <span class="ruby-keyword kw">end</span>
169:                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">chunk_size</span>
170:                         <span class="ruby-identifier">tmp</span> = <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">chunk_size</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>)
171:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tmp</span>.<span class="ruby-identifier">empty?</span>
172:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
173:                         <span class="ruby-keyword kw">else</span>
174:                                 <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tmp</span>
175:                         <span class="ruby-keyword kw">end</span>
176:                 <span class="ruby-keyword kw">end</span>
177:                 
178:                 <span class="ruby-identifier">result</span> = {}
179:                 <span class="ruby-identifier">offset</span> = <span class="ruby-value">0</span>
180:                 <span class="ruby-identifier">delimiter_pos</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">index</span>(<span class="ruby-constant">DELIMITER</span>, <span class="ruby-identifier">offset</span>)
181:                 <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-identifier">delimiter_pos</span>.<span class="ruby-identifier">nil?</span>
182:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
183:                                 <span class="ruby-identifier">name</span> = <span class="ruby-value str">&quot;&quot;</span>
184:                         <span class="ruby-keyword kw">else</span>
185:                                 <span class="ruby-identifier">name</span> = <span class="ruby-identifier">buffer</span>[<span class="ruby-identifier">offset</span> <span class="ruby-operator">..</span> <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>]
186:                         <span class="ruby-keyword kw">end</span>
187:                         
188:                         <span class="ruby-identifier">offset</span> = <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
189:                         <span class="ruby-identifier">delimiter_pos</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">index</span>(<span class="ruby-constant">DELIMITER</span>, <span class="ruby-identifier">offset</span>)
190:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">delimiter_pos</span>.<span class="ruby-identifier">nil?</span>
191:                                 <span class="ruby-identifier">raise</span> <span class="ruby-constant">InvalidHashError</span>
192:                         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
193:                                 <span class="ruby-identifier">value</span> = <span class="ruby-value str">&quot;&quot;</span>
194:                         <span class="ruby-keyword kw">else</span>
195:                                 <span class="ruby-identifier">value</span> = <span class="ruby-identifier">buffer</span>[<span class="ruby-identifier">offset</span> <span class="ruby-operator">..</span> <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>]
196:                         <span class="ruby-keyword kw">end</span>
197:                         
198:                         <span class="ruby-identifier">result</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">value</span>
199:                         <span class="ruby-identifier">offset</span> = <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
200:                         <span class="ruby-identifier">delimiter_pos</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">index</span>(<span class="ruby-constant">DELIMITER</span>, <span class="ruby-identifier">offset</span>)
201:                 <span class="ruby-keyword kw">end</span>
202:                 <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>
203:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNRESET</span>
204:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
205:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000349"></a><b>read_scalar</b>(buffer = new_buffer, max_size = nil)
  </div>
  <div class="description">
  <p>
Read a scalar message from the underlying <a href="../IO.html">IO</a>
object. Returns the <a href="MessageChannel.html#M000347">read</a> message,
or nil on end-of-stream.
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
<p>
The <tt>buffer</tt> argument specifies a buffer in which <a
href="MessageChannel.html#M000349">#read_scalar</a> stores the <a
href="MessageChannel.html#M000347">read</a> data. It is good practice to
reuse existing buffers in order to minimize stress on the garbage
collector.
</p>
<p>
The <tt>max_size</tt> argument allows one to specify the maximum allowed
size for the scalar message. If the received scalar message&#8216;s size is
larger than <tt>max_size</tt>, then a SecurityError will be raised.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000349_source')" id="l_M000349_source">show source</a> ]</p>
  <div id="M000349_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/message_channel.rb, line 220</span>
220:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_scalar</span>(<span class="ruby-identifier">buffer</span> = <span class="ruby-identifier">new_buffer</span>, <span class="ruby-identifier">max_size</span> = <span class="ruby-keyword kw">nil</span>)
221:                 <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-value">4</span>, <span class="ruby-identifier">buffer</span>)
222:                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
223:                 <span class="ruby-keyword kw">end</span>
224:                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span>
225:                         <span class="ruby-identifier">tmp</span> = <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-value">4</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>)
226:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tmp</span>.<span class="ruby-identifier">empty?</span>
227:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
228:                         <span class="ruby-keyword kw">else</span>
229:                                 <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tmp</span>
230:                         <span class="ruby-keyword kw">end</span>
231:                 <span class="ruby-keyword kw">end</span>
232:                 
233:                 <span class="ruby-identifier">size</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">unpack</span>(<span class="ruby-constant">UINT32_PACK_FORMAT</span>)[<span class="ruby-value">0</span>]
234:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
235:                         <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">replace</span>(<span class="ruby-value str">''</span>)
236:                         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">buffer</span>
237:                 <span class="ruby-keyword kw">else</span>
238:                         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">max_size</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">max_size</span>
239:                                 <span class="ruby-identifier">raise</span> <span class="ruby-constant">SecurityError</span>, <span class="ruby-node">&quot;Scalar message size (#{size}) &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
240:                                         <span class="ruby-node">&quot;exceeds maximum allowed size (#{max_size}).&quot;</span>
241:                         <span class="ruby-keyword kw">end</span>
242:                         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">size</span>, <span class="ruby-identifier">buffer</span>)
243:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
244:                         <span class="ruby-keyword kw">end</span>
245:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">size</span>
246:                                 <span class="ruby-identifier">tmp</span> = <span class="ruby-value str">''</span>
247:                                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">size</span>
248:                                         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@io</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>, <span class="ruby-identifier">tmp</span>)
249:                                                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
250:                                         <span class="ruby-keyword kw">else</span>
251:                                                 <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tmp</span>
252:                                         <span class="ruby-keyword kw">end</span>
253:                                 <span class="ruby-keyword kw">end</span>
254:                         <span class="ruby-keyword kw">end</span>
255:                         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">buffer</span>
256:                 <span class="ruby-keyword kw">end</span>
257:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNRESET</span>
258:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
259:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000352"></a><b>recv_io</b>(klass = IO, negotiate = true)
  </div>
  <div class="description">
  <p>
Receive an <a href="../IO.html">IO</a> object (a file descriptor) from the
channel. The other side must have sent an <a href="../IO.html">IO</a>
object by calling <a href="MessageChannel.html#M000353">send_io</a>(). Note
that this only works on Unix sockets.
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000352_source')" id="l_M000352_source">show source</a> ]</p>
  <div id="M000352_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/message_channel.rb, line 297</span>
297:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">recv_io</span>(<span class="ruby-identifier">klass</span> = <span class="ruby-constant">IO</span>, <span class="ruby-identifier">negotiate</span> = <span class="ruby-keyword kw">true</span>)
298:                 <span class="ruby-identifier">write</span>(<span class="ruby-value str">&quot;pass IO&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">negotiate</span>
299:                 <span class="ruby-identifier">io</span> = <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">recv_io</span>(<span class="ruby-identifier">klass</span>)
300:                 <span class="ruby-identifier">write</span>(<span class="ruby-value str">&quot;got IO&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">negotiate</span>
301:                 <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">io</span>
302:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000353"></a><b>send_io</b>(io)
  </div>
  <div class="description">
  <p>
Send an <a href="../IO.html">IO</a> object (a file descriptor) over the
channel. The other side must receive the <a href="../IO.html">IO</a> object
by calling <a href="MessageChannel.html#M000352">recv_io</a>(). Note that
this only works on Unix sockets.
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000353_source')" id="l_M000353_source">show source</a> ]</p>
  <div id="M000353_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/message_channel.rb, line 310</span>
310:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_io</span>(<span class="ruby-identifier">io</span>)
311:                 <span class="ruby-comment cmt"># We read a message before actually calling #send_io</span>
312:                 <span class="ruby-comment cmt"># in order to prevent the other side from accidentally</span>
313:                 <span class="ruby-comment cmt"># read()ing past the normal data and reading our file</span>
314:                 <span class="ruby-comment cmt"># descriptor too.</span>
315:                 <span class="ruby-comment cmt">#</span>
316:                 <span class="ruby-comment cmt"># For example suppose that side A looks like this:</span>
317:                 <span class="ruby-comment cmt">#</span>
318:                 <span class="ruby-comment cmt">#   read(fd, buf, 1024)</span>
319:                 <span class="ruby-comment cmt">#   read_io(fd)</span>
320:                 <span class="ruby-comment cmt">#</span>
321:                 <span class="ruby-comment cmt"># and side B:</span>
322:                 <span class="ruby-comment cmt">#</span>
323:                 <span class="ruby-comment cmt">#   write(fd, buf, 100)</span>
324:                 <span class="ruby-comment cmt">#   send_io(fd_to_pass)</span>
325:                 <span class="ruby-comment cmt">#</span>
326:                 <span class="ruby-comment cmt"># If B completes both write() and send_io(), then A's read() call</span>
327:                 <span class="ruby-comment cmt"># reads past the 100 bytes that B sent. On some platforms, like</span>
328:                 <span class="ruby-comment cmt"># Linux, this will cause read_io() to fail. And it just so happens</span>
329:                 <span class="ruby-comment cmt"># that Ruby's IO#read method slurps more than just the given amount</span>
330:                 <span class="ruby-comment cmt"># of bytes.</span>
331:                 <span class="ruby-identifier">result</span> = <span class="ruby-identifier">read</span>
332:                 <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">result</span>
333:                         <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>, <span class="ruby-value str">&quot;End of stream&quot;</span>
334:                 <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">!=</span> [<span class="ruby-value str">&quot;pass IO&quot;</span>]
335:                         <span class="ruby-identifier">raise</span> <span class="ruby-constant">IOError</span>, <span class="ruby-value str">&quot;IO passing pre-negotiation header expected&quot;</span>
336:                 <span class="ruby-keyword kw">else</span>
337:                         <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">send_io</span>(<span class="ruby-identifier">io</span>)
338:                         <span class="ruby-comment cmt"># Once you've sent the IO you expect to be able to close it on the</span>
339:                         <span class="ruby-comment cmt"># sender's side, even if the other side hasn't read the IO yet.</span>
340:                         <span class="ruby-comment cmt"># Not so: on some operating systems (I'm looking at you OS X) this</span>
341:                         <span class="ruby-comment cmt"># can cause the receiving side to receive a bad file descriptor.</span>
342:                         <span class="ruby-comment cmt"># The post negotiation protocol ensures that we block until the</span>
343:                         <span class="ruby-comment cmt"># other side has really received the IO.</span>
344:                         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">read</span>
345:                         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">result</span>
346:                                 <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>, <span class="ruby-value str">&quot;End of stream&quot;</span>
347:                         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">!=</span> [<span class="ruby-value str">&quot;got IO&quot;</span>]
348:                                 <span class="ruby-identifier">raise</span> <span class="ruby-constant">IOError</span>, <span class="ruby-value str">&quot;IO passing post-negotiation header expected&quot;</span>
349:                         <span class="ruby-keyword kw">end</span>
350:                 <span class="ruby-keyword kw">end</span>
351:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000350"></a><b>write</b>(name, *args)
  </div>
  <div class="description">
  <p>
Send an array message, which consists of the given elements, over the
underlying file descriptor. <em>name</em> is the first element in the
message, and <em>args</em> are the other elements. These arguments will
internally be converted to strings by calling to_s().
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000350_source')" id="l_M000350_source">show source</a> ]</p>
  <div id="M000350_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/message_channel.rb, line 268</span>
268:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">write</span>(<span class="ruby-identifier">name</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
269:                 <span class="ruby-identifier">check_argument</span>(<span class="ruby-identifier">name</span>)
270:                 <span class="ruby-identifier">args</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
271:                         <span class="ruby-identifier">check_argument</span>(<span class="ruby-identifier">arg</span>)
272:                 <span class="ruby-keyword kw">end</span>
273:                 
274:                 <span class="ruby-identifier">message</span> = <span class="ruby-node">&quot;#{name}#{DELIMITER}&quot;</span>
275:                 <span class="ruby-identifier">args</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
276:                         <span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DELIMITER</span>
277:                 <span class="ruby-keyword kw">end</span>
278:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">write</span>([<span class="ruby-identifier">message</span>.<span class="ruby-identifier">size</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'n'</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">message</span>)
279:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">flush</span>
280:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000351"></a><b>write_scalar</b>(data)
  </div>
  <div class="description">
  <p>
Send a scalar message over the underlying <a href="../IO.html">IO</a>
object.
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000351_source')" id="l_M000351_source">show source</a> ]</p>
  <div id="M000351_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/message_channel.rb, line 286</span>
286:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">write_scalar</span>(<span class="ruby-identifier">data</span>)
287:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">write</span>([<span class="ruby-identifier">data</span>.<span class="ruby-identifier">size</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'N'</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span>)
288:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">flush</span>
289:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>

    </body>
</html>