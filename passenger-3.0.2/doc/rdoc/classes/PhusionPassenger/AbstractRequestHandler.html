<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Class: PhusionPassenger::AbstractRequestHandler</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=480,width=750" ).focus();
        }
      // ]]>
    </script>
  </head>

  <body>
  <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'><tr>
  <td class="file-title"><span class="file-title-prefix">Class</span><br />PhusionPassenger::AbstractRequestHandler</td>
  <td align="right">
    <table cellspacing="0" cellpadding="2">
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../files/lib/phusion_passenger/abstract_request_handler_rb.html">lib/phusion_passenger/abstract_request_handler.rb</a>
        </td>
      </tr>
    <tr>
      <td>Parent:</td>
      <td>
Object
     </td>
   </tr>
         </table>
        </td>
        </tr>
      </table>
 <!-- banner header -->

  <div id="bodyContent">
      <div id="content">

  <div class="description"><p>
The request handler is the layer which connects Apache with the underlying
application&#8216;s request dispatcher (i.e. either Rails&#8216;s
Dispatcher class or <a href="Rack.html">Rack</a>). The request
handler&#8216;s job is to process incoming HTTP requests using the
currently loaded Ruby on Rails application. HTTP requests are forwarded to
the request handler by the web server. HTTP responses generated by the RoR
application are forwarded to the web server, which, in turn, sends the
response back to the HTTP client.
</p>
<p>
<a href="AbstractRequestHandler.html">AbstractRequestHandler</a> is an
abstract base class for easing the implementation of request handlers for
Rails and <a href="Rack.html">Rack</a>.
</p>
<h2>Design decisions</h2>
<p>
Some design decisions are made because we want to decrease system
administrator maintenance overhead. These decisions are documented in this
section.
</p>
<h3>Owner pipes</h3>
<p>
Because only the web server communicates directly with a request handler,
we want the request handler to exit if the web server has also exited. This
is implemented by using a so-called _owner pipe_. The writable part of the
pipe will be passed to the web server* via a Unix socket, and the web
server will own that part of the pipe, while <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> owns the
readable part of the pipe. <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> will
continuously check whether the other side of the pipe has been closed. If
so, then it knows that the web server has exited, and so the request
handler will exit as well. This works even if the web server gets killed by
SIGKILL.
</p>
<ul>
<li>It might also be passed to the ApplicationPoolServerExecutable, if the web
server&#8216;s using ApplicationPoolServer instead of
StandardApplicationPool.

</li>
</ul>
<h2>Request format</h2>
<p>
Incoming &quot;HTTP requests&quot; are not true HTTP requests, i.e. their
binary representation do not conform to RFC 2616. Instead, the request
format is based on CGI, and is similar to that of SCGI.
</p>
<p>
The format consists of 3 parts:
</p>
<ul>
<li>A 32-bit big-endian integer, containing the size of the transformed
headers.

</li>
<li>The transformed HTTP headers.

</li>
<li>The verbatim (untransformed) HTTP request body.

</li>
</ul>
<p>
HTTP headers are transformed to a format that satisfies the following
grammar:
</p>
<pre>
 headers ::= header*
 header ::= name NUL value NUL
 name ::= notnull+
 value ::= notnull+
 notnull ::= &quot;\x01&quot; | &quot;\x02&quot; | &quot;\x02&quot; | ... | &quot;\xFF&quot;
 NUL = &quot;\x00&quot;
</pre>
<p>
The web server transforms the HTTP request to the aforementioned format,
and sends it to the request handler.
</p>
</div>



  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="#M000328">cleanup</a></li>
  <li><a href="#M000330">main_loop</a></li>
  <li><a href="#M000329">main_loop_running?</a></li>
  <li><a href="#M000327">new</a></li>
  <li><a href="#M000332">soft_shutdown</a></li>
  <li><a href="#M000331">start_main_loop_thread</a></li>
  </ul>

<div class="sectiontitle">Included Modules</div>
<ul>
  <li><a href="DebugLogging.html">DebugLogging</a></li>
  <li><a href="Utils.html">Utils</a></li>
</ul>



  <div class="sectiontitle">Constants</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class="attr-name">HARD_TERMINATION_SIGNAL</td>
    <td>=</td>
    <td class="attr-value">&quot;SIGTERM&quot;</td>
  </tr>
  <tr valign='top'>
    <td>&nbsp;</td>
    <td colspan="2" class="attr-desc">
<a href="../Signal.html">Signal</a> which will cause the Rails application
to exit immediately.

</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">SOFT_TERMINATION_SIGNAL</td>
    <td>=</td>
    <td class="attr-value">&quot;SIGUSR1&quot;</td>
  </tr>
  <tr valign='top'>
    <td>&nbsp;</td>
    <td colspan="2" class="attr-desc">
<a href="../Signal.html">Signal</a> which will cause the Rails application
to exit as soon as it&#8216;s done processing a request.

</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">BACKLOG_SIZE</td>
    <td>=</td>
    <td class="attr-value">500</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">MAX_HEADER_SIZE</td>
    <td>=</td>
    <td class="attr-value">128 * 1024</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">OBJECT_SPACE_SUPPORTS_LIVE_OBJECTS</td>
    <td>=</td>
    <td class="attr-value">ObjectSpace.respond_to?(:live_objects)</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">OBJECT_SPACE_SUPPORTS_ALLOCATED_OBJECTS</td>
    <td>=</td>
    <td class="attr-value">ObjectSpace.respond_to?(:allocated_objects)</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">OBJECT_SPACE_SUPPORTS_COUNT_OBJECTS</td>
    <td>=</td>
    <td class="attr-value">ObjectSpace.respond_to?(:count_objects)</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">GC_SUPPORTS_TIME</td>
    <td>=</td>
    <td class="attr-value">GC.respond_to?(:time)</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">GC_SUPPORTS_CLEAR_STATS</td>
    <td>=</td>
    <td class="attr-value">GC.respond_to?(:clear_stats)</td>
  </tr>
  </table>

  <div class="sectiontitle">Attributes</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class='attr-rw'>
[RW]
    </td>
    <td class='attr-name'>connect_password</td>
    <td class='attr-desc'>
A password with which clients must authenticate. Default is
unauthenticated.

</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>iterations</td>
    <td class='attr-desc'>
The number of times the main loop has iterated so far. Mostly useful for
unit test assertions.

</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[RW]
    </td>
    <td class='attr-name'>memory_limit</td>
    <td class='attr-desc'>
Specifies the maximum allowed memory usage, in MB. If after having
processed a request <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> detects that
memory usage has risen above this limit, then it will gracefully exit (that
is, exit after having processed all pending requests).

<p>
A value of 0 (the default) indicates that there&#8216;s no limit.
</p>
</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>processed_requests</td>
    <td class='attr-desc'>
Number of requests processed so far. This includes requests that raised
exceptions.

</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>server_sockets</td>
    <td class='attr-desc'>
A hash containing all server sockets that this request handler listens on.
The hash is in the form of:

<pre>
  {
     name1 =&gt; [socket_address1, socket_type1, socket1],
     name2 =&gt; [socket_address2, socket_type2, socket2],
     ...
  }
</pre>
<p>
<tt>name</tt> is a Symbol. <tt>socket_addressx</tt> is the address of the
socket, <tt>socket_typex</tt> is the socket&#8216;s type (either
&#8216;unix&#8217; or &#8216;tcp&#8217;) and <tt>socketx</tt> is the actual
socket <a href="../IO.html">IO</a> objec. There&#8216;s guaranteed to be at
least one server socket, namely one with the name +:main+.
</p>
</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[RW]
    </td>
    <td class='attr-name'>soft_termination_linger_time</td>
    <td class='attr-desc'>
If a soft termination signal was received, then the main loop will quit the
given amount of seconds after the last time a connection was accepted.
Defaults to 3 seconds.

</td>
  </tr>
  </table>

<div class="sectiontitle">Public Class methods</div>
<div class="method">
  <div class="title">
    <a name="M000327"></a><b>new</b>(owner_pipe, options = {})
  </div>
  <div class="description">
  <p>
Create a <a href="AbstractRequestHandler.html#M000327">new</a>
RequestHandler with the given owner pipe. <tt>owner_pipe</tt> must be the
readable part of a pipe <a href="../IO.html">IO</a> object.
</p>
<p>
Additionally, the following options may be given:
</p>
<ul>
<li>memory_limit: Used to set the <tt>memory_limit</tt> attribute.

</li>
<li>detach_key

</li>
<li>connect_password

</li>
<li>pool_account_username

</li>
<li>pool_account_password_base64

</li>
</ul>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000327_source')" id="l_M000327_source">show source</a> ]</p>
  <div id="M000327_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 170</span>
170:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">owner_pipe</span>, <span class="ruby-identifier">options</span> = {})
171:                 <span class="ruby-ivar">@server_sockets</span> = {}
172:                 
173:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">should_use_unix_sockets?</span>
174:                         <span class="ruby-ivar">@main_socket_address</span>, <span class="ruby-ivar">@main_socket</span> = <span class="ruby-identifier">create_unix_socket_on_filesystem</span>
175:                         <span class="ruby-ivar">@server_sockets</span>[<span class="ruby-identifier">:main</span>] = [<span class="ruby-ivar">@main_socket_address</span>, <span class="ruby-value str">'unix'</span>, <span class="ruby-ivar">@main_socket</span>]
176:                 <span class="ruby-keyword kw">else</span>
177:                         <span class="ruby-ivar">@main_socket_address</span>, <span class="ruby-ivar">@main_socket</span> = <span class="ruby-identifier">create_tcp_socket</span>
178:                         <span class="ruby-ivar">@server_sockets</span>[<span class="ruby-identifier">:main</span>] = [<span class="ruby-ivar">@main_socket_address</span>, <span class="ruby-value str">'tcp'</span>, <span class="ruby-ivar">@main_socket</span>]
179:                 <span class="ruby-keyword kw">end</span>
180:                 
181:                 <span class="ruby-ivar">@http_socket_address</span>, <span class="ruby-ivar">@http_socket</span> = <span class="ruby-identifier">create_tcp_socket</span>
182:                 <span class="ruby-ivar">@server_sockets</span>[<span class="ruby-identifier">:http</span>] = [<span class="ruby-ivar">@http_socket_address</span>, <span class="ruby-value str">'tcp'</span>, <span class="ruby-ivar">@http_socket</span>]
183:                 
184:                 <span class="ruby-ivar">@owner_pipe</span> = <span class="ruby-identifier">owner_pipe</span>
185:                 <span class="ruby-ivar">@options</span> = <span class="ruby-identifier">options</span>
186:                 <span class="ruby-ivar">@previous_signal_handlers</span> = {}
187:                 <span class="ruby-ivar">@main_loop_generation</span>  = <span class="ruby-value">0</span>
188:                 <span class="ruby-ivar">@main_loop_thread_lock</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
189:                 <span class="ruby-ivar">@main_loop_thread_cond</span> = <span class="ruby-constant">ConditionVariable</span>.<span class="ruby-identifier">new</span>
190:                 <span class="ruby-ivar">@memory_limit</span>          = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;memory_limit&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
191:                 <span class="ruby-ivar">@connect_password</span>      = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;connect_password&quot;</span>]
192:                 <span class="ruby-ivar">@detach_key</span>            = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;detach_key&quot;</span>]
193:                 <span class="ruby-ivar">@pool_account_username</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;pool_account_username&quot;</span>]
194:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;pool_account_password_base64&quot;</span>]
195:                         <span class="ruby-ivar">@pool_account_password</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;pool_account_password_base64&quot;</span>].<span class="ruby-identifier">unpack</span>(<span class="ruby-value str">'m'</span>).<span class="ruby-identifier">first</span>
196:                 <span class="ruby-keyword kw">end</span>
197:                 <span class="ruby-ivar">@analytics_logger</span>      = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;analytics_logger&quot;</span>]
198:                 <span class="ruby-ivar">@iterations</span>         = <span class="ruby-value">0</span>
199:                 <span class="ruby-ivar">@processed_requests</span> = <span class="ruby-value">0</span>
200:                 <span class="ruby-ivar">@soft_termination_linger_time</span> = <span class="ruby-value">3</span>
201:                 <span class="ruby-ivar">@main_loop_running</span>  = <span class="ruby-keyword kw">false</span>
202:                 <span class="ruby-ivar">@passenger_header</span>   = <span class="ruby-identifier">determine_passenger_header</span>
203:                 
204:                 <span class="ruby-ivar">@debugger</span> = <span class="ruby-ivar">@options</span>[<span class="ruby-value str">&quot;debugger&quot;</span>]
205:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@debugger</span>
206:                         <span class="ruby-ivar">@server_sockets</span>[<span class="ruby-identifier">:ruby_debug_cmd</span>] = [<span class="ruby-node">&quot;127.0.0.1:#{Debugger.cmd_port}&quot;</span>, <span class="ruby-value str">'tcp'</span>]
207:                         <span class="ruby-ivar">@server_sockets</span>[<span class="ruby-identifier">:ruby_debug_ctrl</span>] = [<span class="ruby-node">&quot;127.0.0.1:#{Debugger.ctrl_port}&quot;</span>, <span class="ruby-value str">'tcp'</span>]
208:                 <span class="ruby-keyword kw">end</span>
209:                 
210:                 <span class="ruby-comment cmt">#############</span>
211:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="sectiontitle">Public Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000328"></a><b>cleanup</b>()
  </div>
  <div class="description">
  <p>
Clean up temporary stuff created by the request handler.
</p>
<p>
If the main loop was started by <a
href="AbstractRequestHandler.html#M000330">#main_loop</a>, then this method
may only be called after the main loop has exited.
</p>
<p>
If the main loop was started by <a
href="AbstractRequestHandler.html#M000331">#start_main_loop_thread</a>,
then this method may be called at any time, and it will stop the main loop
thread.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000328_source')" id="l_M000328_source">show source</a> ]</p>
  <div id="M000328_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 220</span>
220:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cleanup</span>
221:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@main_loop_thread</span>
222:                         <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
223:                                 <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
224:                         <span class="ruby-keyword kw">end</span>
225:                         <span class="ruby-ivar">@main_loop_thread</span>.<span class="ruby-identifier">join</span>
226:                 <span class="ruby-keyword kw">end</span>
227:                 <span class="ruby-ivar">@server_sockets</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
228:                         <span class="ruby-identifier">address</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">socket</span> = <span class="ruby-identifier">value</span>
229:                         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
230:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'unix'</span>
231:                                 <span class="ruby-constant">File</span>.<span class="ruby-identifier">unlink</span>(<span class="ruby-identifier">address</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
232:                         <span class="ruby-keyword kw">end</span>
233:                 <span class="ruby-keyword kw">end</span>
234:                 <span class="ruby-ivar">@owner_pipe</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
235:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000330"></a><b>main_loop</b>()
  </div>
  <div class="description">
  <p>
Enter the request handler&#8216;s main loop.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000330_source')" id="l_M000330_source">show source</a> ]</p>
  <div id="M000330_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 243</span>
243:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">main_loop</span>
244:                 <span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;Entering request handler main loop&quot;</span>)
245:                 <span class="ruby-identifier">reset_signal_handlers</span>
246:                 <span class="ruby-keyword kw">begin</span>
247:                         <span class="ruby-ivar">@graceful_termination_pipe</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">pipe</span>
248:                         <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">close_on_exec!</span>
249:                         <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">close_on_exec!</span>
250:                         
251:                         <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
252:                                 <span class="ruby-ivar">@main_loop_generation</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
253:                                 <span class="ruby-ivar">@main_loop_running</span> = <span class="ruby-keyword kw">true</span>
254:                                 <span class="ruby-ivar">@main_loop_thread_cond</span>.<span class="ruby-identifier">broadcast</span>
255:                                 
256:                                 <span class="ruby-ivar">@select_timeout</span> = <span class="ruby-keyword kw">nil</span>
257:                                 
258:                                 <span class="ruby-ivar">@selectable_sockets</span> = []
259:                                 <span class="ruby-ivar">@server_sockets</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
260:                                         <span class="ruby-identifier">socket</span> = <span class="ruby-identifier">value</span>[<span class="ruby-value">2</span>]
261:                                         <span class="ruby-ivar">@selectable_sockets</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">socket</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">socket</span>
262:                                 <span class="ruby-keyword kw">end</span>
263:                                 <span class="ruby-ivar">@selectable_sockets</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@owner_pipe</span>
264:                                 <span class="ruby-ivar">@selectable_sockets</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">0</span>]
265:                         <span class="ruby-keyword kw">end</span>
266:                         
267:                         <span class="ruby-identifier">install_useful_signal_handlers</span>
268:                         <span class="ruby-identifier">socket_wrapper</span> = <span class="ruby-constant">Utils</span><span class="ruby-operator">::</span><span class="ruby-constant">UnseekableSocket</span>.<span class="ruby-identifier">new</span>
269:                         <span class="ruby-identifier">channel</span>        = <span class="ruby-constant">MessageChannel</span>.<span class="ruby-identifier">new</span>
270:                         <span class="ruby-identifier">buffer</span>         = <span class="ruby-value str">''</span>
271:                         
272:                         <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span>
273:                                 <span class="ruby-ivar">@iterations</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
274:                                 <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">accept_and_process_next_request</span>(<span class="ruby-identifier">socket_wrapper</span>, <span class="ruby-identifier">channel</span>, <span class="ruby-identifier">buffer</span>)
275:                                         <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-value str">&quot;Request handler main loop exited normally&quot;</span>)
276:                                         <span class="ruby-keyword kw">break</span>
277:                                 <span class="ruby-keyword kw">end</span>
278:                                 <span class="ruby-ivar">@processed_requests</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
279:                         <span class="ruby-keyword kw">end</span>
280:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
281:                         <span class="ruby-comment cmt"># Exit main loop.</span>
282:                         <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-value str">&quot;Request handler main loop interrupted by EOFError exception&quot;</span>)
283:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Interrupt</span>
284:                         <span class="ruby-comment cmt"># Exit main loop.</span>
285:                         <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-value str">&quot;Request handler main loop interrupted by Interrupt exception&quot;</span>)
286:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SignalException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">signal</span>
287:                         <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-value str">&quot;Request handler main loop interrupted by SignalException&quot;</span>)
288:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">signal</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">HARD_TERMINATION_SIGNAL</span> <span class="ruby-operator">&amp;&amp;</span>
289:                            <span class="ruby-identifier">signal</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">SOFT_TERMINATION_SIGNAL</span>
290:                                 <span class="ruby-identifier">raise</span>
291:                         <span class="ruby-keyword kw">end</span>
292:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
293:                         <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-node">&quot;Request handler main loop interrupted by #{e.class} exception&quot;</span>)
294:                         <span class="ruby-identifier">raise</span>
295:                 <span class="ruby-keyword kw">ensure</span>
296:                         <span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;Exiting request handler main loop&quot;</span>)
297:                         <span class="ruby-identifier">revert_signal_handlers</span>
298:                         <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
299:                                 <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
300:                                 <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
301:                                 <span class="ruby-ivar">@selectable_sockets</span> = []
302:                                 <span class="ruby-ivar">@main_loop_generation</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
303:                                 <span class="ruby-ivar">@main_loop_running</span> = <span class="ruby-keyword kw">false</span>
304:                                 <span class="ruby-ivar">@main_loop_thread_cond</span>.<span class="ruby-identifier">broadcast</span>
305:                         <span class="ruby-keyword kw">end</span>
306:                 <span class="ruby-keyword kw">end</span>
307:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000329"></a><b>main_loop_running?</b>()
  </div>
  <div class="description">
  <p>
Check whether the main loop&#8216;s currently running.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000329_source')" id="l_M000329_source">show source</a> ]</p>
  <div id="M000329_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 238</span>
238:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">main_loop_running?</span>
239:                 <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@main_loop_running</span>
240:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000332"></a><b>soft_shutdown</b>()
  </div>
  <div class="description">
  <p>
Remove this request handler from the application pool so that no <a
href="AbstractRequestHandler.html#M000327">new</a> connections will come
in. Then make the main loop quit a few seconds after the last time a
connection came in. This all is to ensure that no connections come in while
we&#8216;re shutting down.
</p>
<p>
May only be called while the main loop is running. May be called from any
thread.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000332_source')" id="l_M000332_source">show source</a> ]</p>
  <div id="M000332_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 333</span>
333:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">soft_shutdown</span>
334:                 <span class="ruby-ivar">@select_timeout</span> = <span class="ruby-ivar">@soft_termination_linger_time</span>
335:                 <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
336:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@detach_key</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@pool_account_username</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@pool_account_password</span>
337:                         <span class="ruby-identifier">client</span> = <span class="ruby-constant">MessageClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@pool_account_username</span>, <span class="ruby-ivar">@pool_account_password</span>)
338:                         <span class="ruby-keyword kw">begin</span>
339:                                 <span class="ruby-identifier">client</span>.<span class="ruby-identifier">detach</span>(<span class="ruby-ivar">@detach_key</span>)
340:                         <span class="ruby-keyword kw">ensure</span>
341:                                 <span class="ruby-identifier">client</span>.<span class="ruby-identifier">close</span>
342:                         <span class="ruby-keyword kw">end</span>
343:                 <span class="ruby-keyword kw">end</span>
344:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000331"></a><b>start_main_loop_thread</b>()
  </div>
  <div class="description">
  <p>
Start the main loop in a <a
href="AbstractRequestHandler.html#M000327">new</a> thread. This thread will
be stopped by <a href="AbstractRequestHandler.html#M000328">#cleanup</a>.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000331_source')" id="l_M000331_source">show source</a> ]</p>
  <div id="M000331_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 310</span>
310:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_main_loop_thread</span>
311:                 <span class="ruby-identifier">current_generation</span> = <span class="ruby-ivar">@main_loop_generation</span>
312:                 <span class="ruby-ivar">@main_loop_thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span>
313:                         <span class="ruby-keyword kw">begin</span>
314:                                 <span class="ruby-identifier">main_loop</span>
315:                         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
316:                                 <span class="ruby-identifier">print_exception</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>, <span class="ruby-identifier">e</span>)
317:                         <span class="ruby-keyword kw">end</span>
318:                 <span class="ruby-keyword kw">end</span>
319:                 <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
320:                         <span class="ruby-keyword kw">while</span> <span class="ruby-ivar">@main_loop_generation</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_generation</span>
321:                                 <span class="ruby-ivar">@main_loop_thread_cond</span>.<span class="ruby-identifier">wait</span>(<span class="ruby-ivar">@main_loop_thread_lock</span>)
322:                         <span class="ruby-keyword kw">end</span>
323:                 <span class="ruby-keyword kw">end</span>
324:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>

    </body>
</html>