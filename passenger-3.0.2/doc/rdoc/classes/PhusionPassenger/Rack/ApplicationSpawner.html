<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Class: PhusionPassenger::Rack::ApplicationSpawner</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=480,width=750" ).focus();
        }
      // ]]>
    </script>
  </head>

  <body>
  <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'><tr>
  <td class="file-title"><span class="file-title-prefix">Class</span><br />PhusionPassenger::Rack::ApplicationSpawner</td>
  <td align="right">
    <table cellspacing="0" cellpadding="2">
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../../files/lib/phusion_passenger/rack/application_spawner_rb.html">lib/phusion_passenger/rack/application_spawner.rb</a>
        </td>
      </tr>
    <tr>
      <td>Parent:</td>
      <td>
AbstractServer
     </td>
   </tr>
         </table>
        </td>
        </tr>
      </table>
 <!-- banner header -->

  <div id="bodyContent">
      <div id="content">

  <div class="description"><p>
Spawning of <a href="../Rack.html">Rack</a> applications.
</p>
</div>



  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="#M000021">new</a></li>
  <li><a href="#M000020">spawn_application</a></li>
  <li><a href="#M000022">spawn_application</a></li>
  <li><a href="#M000023">start</a></li>
  </ul>

<div class="sectiontitle">Included Modules</div>
<ul>
  <li><a href="../Utils.html">Utils</a></li>
  <li><a href="../DebugLogging.html">DebugLogging</a></li>
</ul>


  <div class="sectiontitle">Classes and Modules</div>
  Class <a href="ApplicationSpawner/Error.html" class="link">PhusionPassenger::Rack::ApplicationSpawner::Error</a><br />




<div class="sectiontitle">Public Class methods</div>
<div class="method">
  <div class="title">
    <a name="M000021"></a><b>new</b>(options)
  </div>
  <div class="description">
  <p>
The following options are accepted:
</p>
<ul>
<li>&#8216;app_root&#8216;

</li>
</ul>
<p>
See <a
href="../SpawnManager.html#M000366">SpawnManager#spawn_application</a> for
information about the options.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000021_source')" id="l_M000021_source">show source</a> ]</p>
  <div id="M000021_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/rack/application_spawner.rb, line 95</span>
 95:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">options</span>)
 96:                 <span class="ruby-keyword kw">super</span>()
 97:                 <span class="ruby-ivar">@options</span>          = <span class="ruby-identifier">sanitize_spawn_options</span>(<span class="ruby-identifier">options</span>)
 98:                 <span class="ruby-ivar">@app_root</span>         = <span class="ruby-ivar">@options</span>[<span class="ruby-value str">&quot;app_root&quot;</span>]
 99:                 <span class="ruby-ivar">@canonicalized_app_root</span> = <span class="ruby-identifier">canonicalize_path</span>(<span class="ruby-ivar">@app_root</span>)
100:                 <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">max_idle_time</span> = <span class="ruby-constant">DEFAULT_APP_SPAWNER_MAX_IDLE_TIME</span>
101:                 <span class="ruby-identifier">define_message_handler</span>(<span class="ruby-identifier">:spawn_application</span>, <span class="ruby-identifier">:handle_spawn_application</span>)
102:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000020"></a><b>spawn_application</b>(options = {})
  </div>
  <div class="description">
  <p>
Spawn an instance of the given <a href="../Rack.html">Rack</a> application.
When successful, an <a href="../AppProcess.html">AppProcess</a> object will
be returned, which represents the spawned application.
</p>
<p>
Accepts the same options as <a
href="../SpawnManager.html#M000366">SpawnManager#spawn_application</a>.
</p>
<p>
Raises:
</p>
<ul>
<li><a href="../AppInitError.html">AppInitError</a>: The <a
href="../Rack.html">Rack</a> application raised an exception or called
exit() during startup.

</li>
<li>SystemCallError, IOError, SocketError: Something went wrong.

</li>
</ul>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000020_source')" id="l_M000020_source">show source</a> ]</p>
  <div id="M000020_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File lib/phusion_passenger/rack/application_spawner.rb, line 59</span>
59:         <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">spawn_application</span>(<span class="ruby-identifier">options</span> = {})
60:                 <span class="ruby-identifier">options</span> = <span class="ruby-identifier">sanitize_spawn_options</span>(<span class="ruby-identifier">options</span>)
61:                 
62:                 <span class="ruby-identifier">a</span>, <span class="ruby-identifier">b</span> = <span class="ruby-constant">UNIXSocket</span>.<span class="ruby-identifier">pair</span>
63:                 <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">safe_fork</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-keyword kw">true</span>) <span class="ruby-keyword kw">do</span>
64:                         <span class="ruby-identifier">a</span>.<span class="ruby-identifier">close</span>
65:                         
66:                         <span class="ruby-identifier">file_descriptors_to_leave_open</span> = [<span class="ruby-value">0</span>, <span class="ruby-value">1</span>, <span class="ruby-value">2</span>, <span class="ruby-identifier">b</span>.<span class="ruby-identifier">fileno</span>]
67:                         <span class="ruby-constant">NativeSupport</span>.<span class="ruby-identifier">close_all_file_descriptors</span>(<span class="ruby-identifier">file_descriptors_to_leave_open</span>)
68:                         <span class="ruby-identifier">close_all_io_objects_for_fds</span>(<span class="ruby-identifier">file_descriptors_to_leave_open</span>)
69:                         
70:                         <span class="ruby-identifier">channel</span> = <span class="ruby-constant">MessageChannel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">b</span>)
71:                         <span class="ruby-identifier">app</span> = <span class="ruby-keyword kw">nil</span>
72:                         <span class="ruby-identifier">success</span> = <span class="ruby-identifier">report_app_init_status</span>(<span class="ruby-identifier">channel</span>) <span class="ruby-keyword kw">do</span>
73:                                 <span class="ruby-identifier">prepare_app_process</span>(<span class="ruby-value str">'config.ru'</span>, <span class="ruby-identifier">options</span>)
74:                                 <span class="ruby-identifier">app</span> = <span class="ruby-identifier">load_rack_app</span>
75:                                 <span class="ruby-identifier">after_loading_app_code</span>(<span class="ruby-identifier">options</span>)
76:                         <span class="ruby-keyword kw">end</span>
77:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">success</span>
78:                                 <span class="ruby-identifier">start_request_handler</span>(<span class="ruby-identifier">channel</span>, <span class="ruby-identifier">app</span>, <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">options</span>)
79:                         <span class="ruby-keyword kw">end</span>
80:                 <span class="ruby-keyword kw">end</span>
81:                 <span class="ruby-identifier">b</span>.<span class="ruby-identifier">close</span>
82:                 <span class="ruby-constant">Process</span>.<span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
83:                 
84:                 <span class="ruby-identifier">channel</span> = <span class="ruby-constant">MessageChannel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">a</span>)
85:                 <span class="ruby-identifier">unmarshal_and_raise_errors</span>(<span class="ruby-identifier">channel</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;print_exceptions&quot;</span>], <span class="ruby-value str">&quot;rack&quot;</span>)
86:                 
87:                 <span class="ruby-comment cmt"># No exception was raised, so spawning succeeded.</span>
88:                 <span class="ruby-keyword kw">return</span> <span class="ruby-constant">AppProcess</span>.<span class="ruby-identifier">read_from_channel</span>(<span class="ruby-identifier">channel</span>)
89:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="sectiontitle">Public Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000022"></a><b>spawn_application</b>(options = {})
  </div>
  <div class="description">
  <p>
Spawns an instance of the <a href="../Rack.html">Rack</a> application. When
successful, an <a href="../AppProcess.html">AppProcess</a> object will be
returned, which represents the spawned <a href="../Rack.html">Rack</a>
application.
</p>
<p>
<tt>options</tt> will be passed to the request handler&#8216;s constructor.
</p>
<p>
Raises:
</p>
<ul>
<li><a
href="../AbstractServer/ServerNotStarted.html">AbstractServer::ServerNotStarted</a>:
The <a href="ApplicationSpawner.html">ApplicationSpawner</a> server
hasn&#8216;t already been started.

</li>
<li><a href="ApplicationSpawner/Error.html">ApplicationSpawner::Error</a>: The
<a href="ApplicationSpawner.html">ApplicationSpawner</a> server exited
unexpectedly.

</li>
</ul>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000022_source')" id="l_M000022_source">show source</a> ]</p>
  <div id="M000022_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/rack/application_spawner.rb, line 112</span>
112:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">spawn_application</span>(<span class="ruby-identifier">options</span> = {})
113:                 <span class="ruby-identifier">connect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">channel</span><span class="ruby-operator">|</span>
114:                         <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value str">&quot;spawn_application&quot;</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">options</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">flatten</span>)
115:                         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">AppProcess</span>.<span class="ruby-identifier">read_from_channel</span>(<span class="ruby-identifier">channel</span>)
116:                 <span class="ruby-keyword kw">end</span>
117:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>, <span class="ruby-constant">IOError</span>, <span class="ruby-constant">SocketError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
118:                 <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-node">&quot;The application spawner server exited unexpectedly: #{e}&quot;</span>
119:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000023"></a><b>start</b>()
  </div>
  <div class="description">
  <p>
Overrided from <a
href="../AbstractServer.html#M000334">AbstractServer#start</a>.
</p>
<p>
May raise these additional exceptions:
</p>
<ul>
<li><a href="../AppInitError.html">AppInitError</a>: The <a
href="../Rack.html">Rack</a> application raised an exception or called
exit() during startup.

</li>
<li><a href="ApplicationSpawner/Error.html">ApplicationSpawner::Error</a>: The
<a href="ApplicationSpawner.html">ApplicationSpawner</a> server exited
unexpectedly.

</li>
</ul>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000023_source')" id="l_M000023_source">show source</a> ]</p>
  <div id="M000023_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/rack/application_spawner.rb, line 127</span>
127:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start</span>
128:                 <span class="ruby-keyword kw">super</span>
129:                 <span class="ruby-keyword kw">begin</span>
130:                         <span class="ruby-identifier">channel</span> = <span class="ruby-constant">MessageChannel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@owner_socket</span>)
131:                         <span class="ruby-identifier">unmarshal_and_raise_errors</span>(<span class="ruby-identifier">channel</span>, <span class="ruby-ivar">@options</span>[<span class="ruby-value str">&quot;print_exceptions&quot;</span>])
132:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">IOError</span>, <span class="ruby-constant">SystemCallError</span>, <span class="ruby-constant">SocketError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
133:                         <span class="ruby-identifier">stop</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">started?</span>
134:                         <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-node">&quot;The application spawner server exited unexpectedly: #{e}&quot;</span>
135:                 <span class="ruby-keyword kw">rescue</span>
136:                         <span class="ruby-identifier">stop</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">started?</span>
137:                         <span class="ruby-identifier">raise</span>
138:                 <span class="ruby-keyword kw">end</span>
139:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>

    </body>
</html>